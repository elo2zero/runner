---
title: "Apply any R function on rolling windows"
author: "Dawid Kałędkowski"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The runner package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Using runner
![](images/using_runner.png)
`runner` package provides functions applied on running windows. The most 
universal function is `runner::runner` which gives user possibility to apply 
any R function `f` on running windows. Running windows are defined for each data
window size `k`, `lag` with respect to their indexes. Unlike other available R 
packages, `runner` supports any input and output type and also gives full control
to manipulate window size and lag/lead.

There are different kinds of running windows and all of them are implemented in
`runner`.

### Cumulative windows

The simplest window type which is similar to `base::cumsum`. At each element
window is defined by all elements appearing before current.

![](images/cumulative_windows.png)

In `runner` this can be achieved as simple as:

```{r eval=FALSE}
# summarizing - sum
runner(
  1:15,
  f = sum
)

# summarizing - concatenating
runner(
  letters[1:15],
  f = paste,
  collapse = " > "
)

# full windows
runner(
  1:15,
  f = function(x) x
)
```

### Constant sliding windows

Second type of windows are these commonly known as running/rolling/moving/sliding windows. 
This types of windows moves along the index instead of "streaching" like a previous ones.  
Following diagram illustrates running windows of length `k = 4`. For each of 15 
elements of a vector each window contains current 4 elements.

![](images/running_windows_explain.png)

To obtain constant sliding windows one just needs to specify `k` argument 

```{r eval=FALSE}
# summarizing - sum of 4-elements
runner(
  1:15,
  k = 4,
  f = sum
)

# summarizing - concatenating
runner(
  x = data.frame(
    a = 1:15,
    b = 3 * 1:15 + runif(15)
  ),
  k = 5,
  f = function(x) {
    model <- lm(b ~ a, data = x)
    coefficients(model)
  }
)
```

### Windows depending on date
By default `runner` calculates assumming index incremented by one, but sometimes 
data points in dataset are not equally spaced (missing weekends, holidays, other missings) 
and thus window size should vary to keep expected time frame. If one specifies 
`idx` argument, than running functions are applied on windows depending on date. 
`idx` should be the same length as `x` of class `Date`, `POSIXt` or `integer`.
Example below illustrates window of size `k = 5` lagged by `lag = 1`. 
In parentheses ranges for each window.


![](images/running_date_windows.png)

```{r eval=FALSE}
idx <- c(4, 6, 7, 13, 17, 18, 18, 21, 27, 31, 37, 42, 44, 47, 48)

# summarize - mean
runner::runner(
  x = 1:15, 
  k = 5,
  lag = 1,
  idx = idx,
  f = function(x) mean(x)
)

# full window - no summarization
runner::runner(
  x = idx, 
  k = 5,
  lag = 1,
  idx = idx,
  f = function(x) x
)
```

### running at

Runner by default returns vector of the same size as `x` unless one puts any-size 
vector to `at` argument. Each element of `at` is an index on which runner 
calculates function. Example below illustrates output of runner for `at = c(13, 27, 45, 31)` 
which gives windows in ranges enclosed in square brackets. Range for `at = 27` is
`[22, 26]` which is not available in current indices.  

![](images/runner_at_date.png)
```{r eval=FALSE}
idx <- c(4, 6, 7, 13, 17, 18, 18, 21, 27, 31, 37, 42, 44, 47, 48)

# summary
runner::runner(x = 1:15, 
               k = 5,
               lag = 1,
               idx = idx,
               at = c(18, 27, 48, 31),
               f = mean)

# full window
runner::runner(x = idx, 
               k = 5,
               lag = 1,
               idx = idx,
               at = c(18, 27, 48, 31),
               f = function(x) x)
```

`at` can also be specified as interval of the output defined by `at = "<time unit>"` 
which results in obtaining results on following indices 
`seq(min(idx), max(idx), by = "<time unit>")`. `"<time unit>"` is the same as in 
seq.POSIXt function. It's worth noting that time-unit can't be more frequent than 
idx - for Date the most frequent time-unit is a "day", for POSIXt a sec.
```{r eval=FALSE}
data("dummy_hour")


# 2-yearly aggregation of hourly data
runner(
  dummy_hour,
  k = 2 * 365 * 24 * 60 * 60, # days*hours*mins*secs
  idx = dummy_hour$hour, # YYYY:mm:dd HH:MM:SS
  at = "2 years",
  f = function(x) {
    data.frame(
      year = paste(as.Date(min(x$hour)), as.Date(max(x$hour))),
      val1_mean = mean(x$val1),
      val2_mean = mean(x$val2),
      val3_mean = mean(x$val3)
    )
  }
)

```

### Varying window length

Argument `k` defines number of elements (or periods) in window. If `k` is a single value then 
window size is constant for all elements of x. User can also specify `k` for 
varying window size, then `k` should be a vector of length equal to length of `x` 
or `at` (if specified). `k` can't be negative.

```{r eval=FALSE}
# summarizing - concatenating
runner::runner(
  x = 1:10, 
  k = c(0, 1, 1, 1, 1, 5, 5, 5, 5, 5), 
  f = paste,
  collapse = ","
)

# full window
runner::runner(
  x = 1:10, 
  k = c(1, 1, 1, 1, 1, 5, 5, 5, 5, 5), 
  f = function(x) x
)
```

### Lagged windows
`lag` denotes how many observations (or periods) windows will be lagged by. If `lag` is a 
single value than it is constant for all elements of x. For varying lag size, `lag` 
should be a vector of length equal to length of `x` or `at` (if specified). 
Default value of `lag = 0`. 
Example below illustrates window of `k = 4` lagged by `lag = 2` for 10'th element of 
vector `x`. Lag can also be negative value, which shifts window forward instead 
of backward.


```{r eval=FALSE}
# summarize by mean
runner::runner(
  x = 1:15, 
  k = 4, 
  lag = 2,
  f = mean
)

# full windows
runner::runner(
  x = 1:15, 
  k = 4, 
  lag = 2,
  f = function(x) x
)
```

### `NA` padding  
Using `runner` one can also specify `na_pad = TRUE` which would return `NA` for 
any window which is partially out of range - meaning that there is no sufficient 
number of observations to fill the window. By default `na_pad = FALSE`, which 
means that incomplete windows are calculated anyway. `na_pad` is applied on 
normal cumulative windows and on windows depending on date. In example below two
windows exceed range given by `idx` so for these windows are empty for 
`na_pad = TRUE`. If used sets `na_pad = FALSE` first window will be empty 
(no single element within `[-2, 3]`) and last window will return elements within
matching `idx`.

![](images/runner_at_date_na_pad.png)

```{r eval=FALSE}
idx <- c(4, 6, 7, 13, 17, 18, 18, 21, 27, 31, 37, 42, 44, 47, 48)
runner::runner(x = 1:15, 
               k = 5, 
               lag = 1, 
               idx = idx, 
               at = c(4, 18, 48, 51),
               na_pad = TRUE,
               f = function(x) mean(x))
```

### Build-in functions
With `runner` one can use any R functions, but some of them are optimized for 
speed reasons.
These functions are:  
- aggregating functions - `length_run`, `min_run`, `max_run`, `minmax_run`,
`sum_run`, `mean_run`, `streak_run`  
- utility functions - `fill_run`, `lag_run`, `which_run`
